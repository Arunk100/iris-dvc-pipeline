name: Build, generate model, and push image

# allow manual dispatch and trigger on push (so your commits will run it)
on:
  workflow_dispatch:
  push:
    branches: [ dev ]

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install DVC & Python deps
        run: |
          python -m pip install --upgrade pip
          pip install "dvc[gs]==3.50.1" scikit-learn pandas joblib

      - name: Diagnostic - show repo files
        run: |
          echo "Listing top-level files"
          ls -la

      - name: DVC pull (force overwrite existing files)
        run: |
          # Force allows overwriting files that already exist in the workspace
          dvc pull --force

      - name: Build image (no-cache for reproducibility)
        env:
          IMAGE: ghcr.io/arunk100/iris-dvc-pipeline:latest
        run: |
          docker build --no-cache -t "${IMAGE}" .
          echo "$GHCR_TOKEN" | docker login ghcr.io -u arunk100 --password-stdin
          docker push "${IMAGE}"

      - name: (optional) kubectl deploy / smoke test
        if: false
        run: |
          # optional: put kubectl commands here if you want Actions to deploy
          echo "Add deployment steps here if desired"
