name: Build and Push with Model

on:
  push:
    branches:
      - dev  # Or 'main', depending on your branch

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write # Required to push to GHCR

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install DVC and GCS
      run: pip install dvc[gcs] # Installs DVC and the Google Cloud plugin

    - name: Authenticate Google Cloud
      uses: 'google-github-actions/auth@v1'
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}' # Your DVC puller secret

    - name: Pull DVC data
      run: dvc pull --force # Use --force to overwrite placeholders

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GHCR_TOKEN }} # Your token with package:write scope

    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: ghcr.io/arunk100/iris-dvc-pipeline:latest # Make sure 'arunk100' is lowercase
        no-cache: true  # <--- ADD THIS LINE
